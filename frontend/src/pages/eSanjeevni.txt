import React, { useState, useMemo, useEffect, useRef } from 'react';
import { supabase } from '../supabaseClient';
import { 
  ArrowLeft, Video, Plus, Clock, AlertCircle, X, 
  ChevronDown, Search, Filter, Star, CheckCircle, 
  Calendar, PhoneCall, UserPlus, PhoneOff, Camera, Mic
} from 'lucide-react';

// --- MOCK DATA ---
const DOCTORS = [
  { id: 'd1', name: 'Dr. Sharma', spec: 'Cardiologist', hospital: 'District Hospital', status: 'Offline', rating: 4.8 },
  { id: 'd2', name: 'Dr. Iyer', spec: 'Gynecologist', hospital: 'Women & Child Care', status: 'Online', rating: 4.9 }, 
  { id: 'd3', name: 'Dr. Khan', spec: 'Pediatrician', hospital: 'City Clinic', status: 'Offline', rating: 4.7 },
  { id: 'd4', name: 'Dr. Rao', spec: 'General Physician', hospital: 'Community Center', status: 'Offline', rating: 4.5 },
  { id: 'd5', name: 'Dr. Patel', spec: 'Endocrinologist', hospital: 'District Hospital', status: 'Offline', rating: 4.6 },
];

const DISEASE_TO_SPEC_MAP = {
  'Hypertension': 'Cardiologist',
  'High Risk Pregnancy': 'Gynecologist',
  'Child Malnutrition': 'Pediatrician',
  'Diabetes': 'Endocrinologist',
  'Asthma': 'General Physician',
  'Severe Anemia': 'General Physician',
  'Skin Infection': 'General Physician'
};

// Added missing mock arrays for the Add Consultation Modal
const AVAILABLE_PATIENTS = ['Ramesh Kumar', 'Sita Devi', 'Amit Singh', 'Priya Patel'];
const AVAILABLE_DISEASES = Object.keys(DISEASE_TO_SPEC_MAP);

// --- MAIN COMPONENT ---
export default function Esanjeevni() {
  const pendingCandidatesRef = useRef([]);
  const [members, setMembers] = useState([]);
  const [loading, setLoading] = useState(true);
  const [searchQuery, setSearchQuery] = useState('');
  const [availableDiseases, setAvailableDiseases] = useState([]);
  const [activeFilter, setActiveFilter] = useState('All');
  
  // Modals state
  const [assignModalOpen, setAssignModalOpen] = useState(false);
  const [selectedConsultationId, setSelectedConsultationId] = useState(null);
  const [addModalOpen, setAddModalOpen] = useState(false);
  const [activeCall, setActiveCall] = useState(null);

  useEffect(() => {
    fetchMembers();
  }, []);
  
  const answerSetRef = useRef(false);
  
  const fetchMembers = async () => {
    setLoading(true);
    try {
      const { data, error } = await supabase.from('members').select('*, families(village)');
      if (error) throw error;

      const uniqueDiseases = new Set();
      
      const formattedMembers = data.map(m => {
        const tags = [];
        const extractTags = (jsonObj) => {
          if (!jsonObj) return;
          Object.entries(jsonObj).forEach(([key, value]) => {
            if (value === 'Yes' || value === true) {
              const formattedTag = key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
              tags.push(formattedTag);
              uniqueDiseases.add(formattedTag);
            }
          });
        };

        extractTags(m.history);
        extractTags(m.symptoms);

        let priority = 'Low Risk';
        if (m.risk_level === 'Red') priority = 'High Risk';
        if (m.risk_level === 'Orange') priority = 'Moderate Risk';

        return {
          id: m.id,
          patientName: m.name,
          age: m.age,
          abhaId: m.abha_id || '',
          village: m.families?.village || 'Unknown',
          diseaseTags: tags,
          priority: priority,
          type: m.type,
          status: 'Not Started',
          assignedDoctorId: null,
          referralRecommended: m.risk_level === 'Red'
        };
      });

      setMembers(formattedMembers);
      setAvailableDiseases(Array.from(uniqueDiseases).sort());
    } catch (error) {
      console.error("Error fetching members:", error);
    } finally {
      setLoading(false);
    }
  };

  // Derived & Filtered Data
  const filteredAndSortedMembers = useMemo(() => {
    let filtered = members;

    if (searchQuery.trim() !== '') {
      filtered = filtered.filter(m => 
        m.abhaId.replace(/\s/g, '').includes(searchQuery.replace(/\s/g, ''))
      );
    }

    if (activeFilter !== 'All') {
      if (['High Risk', 'Moderate Risk', 'Low Risk'].includes(activeFilter)) {
        filtered = filtered.filter(m => m.priority === activeFilter);
      } else if (['Pregnancy', 'Child'].includes(activeFilter)) {
        filtered = filtered.filter(m => m.type === activeFilter);
      } else {
        filtered = filtered.filter(m => m.diseaseTags.includes(activeFilter));
      }
    }

    return filtered.sort((a, b) => {
      if (a.priority === 'High Risk' && b.priority !== 'High Risk') return -1;
      if (a.priority !== 'High Risk' && b.priority === 'High Risk') return 1;
      return 0;
    });
  }, [members, activeFilter, searchQuery]);

  // Handlers
  const handleAssignDoctor = (consultationId, doctorId) => {
    setMembers(prev => prev.map(c => {
      if (c.id === consultationId) {
        const doc = DOCTORS.find(d => d.id === doctorId);
        return { 
          ...c, 
          assignedDoctorId: doctorId, 
          status: doc.status === 'Online' ? 'Not Started' : 'Scheduled' 
        };
      }
      return c;
    }));
    setAssignModalOpen(false);
  };

  const handleAddConsultation = (newConsultation) => {
    setMembers(prev => [{...newConsultation, id: `c${Date.now()}`}, ...prev]);
    setAddModalOpen(false);
  };

  const updateStatus = (id, newStatus) => {
    setMembers(prev => prev.map(c => c.id === id ? { ...c, status: newStatus } : c));
  };

  const handleStartCall = async (consultation) => {
    try {
      let stream;
      try {
        stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
      } catch (mediaError) {
        alert(`Camera/Mic Error: Please allow permissions.`);
        return; 
      }

      const pc = new RTCPeerConnection({
        iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
      });

      stream.getTracks().forEach(track => {
        pc.addTrack(track, stream);
      });

      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);

      const reportData = {
        name: consultation.patientName,
        age: consultation.age,
        history: consultation.diseaseTags,
        priority: consultation.priority,
        village: consultation.village,
        abhaId: consultation.abhaId
      };

      // Add this inside your main Esanjeevni component
  const handleEndCall = (consultationId) => {
    // 1. Close WebRTC Connection
    if (activeCall?.pc) {
      activeCall.pc.close();
    }
    
    // 2. Stop all camera/mic tracks
    if (activeCall?.stream) {
      activeCall.stream.getTracks().forEach(track => track.stop());
    }

    // 3. Update the patient status in the list to 'Completed'
    setMembers(prev => prev.map(m => 
      m.id === consultationId ? { ...m, status: 'Completed' } : m
    ));

    // 4. Close the video overlay
    setActiveCall(null);
  };

      const { data, error } = await supabase
        .from('live_consultations')
        .insert([{
          doctor_id: consultation.assignedDoctorId,
          patient_id: consultation.id,
          patient_report: reportData,
          status: 'calling',
          offer: JSON.stringify(offer),
          ice_offer: JSON.stringify([]) // Initialize empty array
        }])
        .select()
        .single();

      if (error) throw error;

      // 1. OUTGOING: Accumulate candidates into an array to prevent overwrites
      const localIceCandidates = [];
      pc.onicecandidate = async (event) => {
        if (event.candidate) {
          localIceCandidates.push(event.candidate);
          await supabase
            .from('live_consultations')
            .update({ ice_offer: JSON.stringify(localIceCandidates) })
            .eq('id', data.id);
        }
      };

      // 2. INCOMING: Listen immediately on a single unified channel
      let doctorIceProcessed = 0;

      supabase
        .channel(`call-sync-${data.id}`)
        .on('postgres_changes', {
          event: 'UPDATE',
          schema: 'public',
          table: 'live_consultations',
          filter: `id=eq.${data.id}`
        }, async (payload) => {
          
          // Handle Answer when it arrives
          if (payload.new.answer && !pc.currentRemoteDescription) {
            const answer = JSON.parse(payload.new.answer);
            await pc.setRemoteDescription(new RTCSessionDescription(answer));

            // Flush any ICE candidates that arrived before the answer
            for (const candidate of pendingCandidatesRef.current) {
              await pc.addIceCandidate(new RTCIceCandidate(candidate)).catch(console.error);
            }
            pendingCandidatesRef.current = []; // Clear queue
          }

          // Handle incoming Array of Doctor's ICE Candidates
          if (payload.new.ice_answer) {
            const candidatesArray = JSON.parse(payload.new.ice_answer);
            
            // Only process new candidates we haven't seen yet
            for (let i = doctorIceProcessed; i < candidatesArray.length; i++) {
              const candidate = candidatesArray[i];
              if (pc.remoteDescription) {
                await pc.addIceCandidate(new RTCIceCandidate(candidate)).catch(console.error);
              } else {
                // Queue them safely if the Answer hasn't arrived yet
                pendingCandidatesRef.current.push(candidate);
              }
              doctorIceProcessed++;
            }
          }
        })
        .subscribe();
        
      setActiveCall({ ...consultation, pc, stream });

    } catch (error) {
      console.error("Connection failed:", error);
      alert("Database connection failed. Check console for details.");
    }
  };

  if (activeCall) {
    return <VideoCallView consultation={activeCall} onEndCall={handleEndCall} />;
  }

  return (
    <div className="mx-auto max-w-md bg-gray-50 min-h-screen relative shadow-2xl overflow-hidden flex flex-col font-sans">
      
      {/* HEADER SECTION */}
      <header className="bg-white px-4 pt-6 pb-4 sticky top-0 z-10 shadow-sm rounded-b-[24px]">
        <div className="flex items-center justify-between mb-4">
          <div className="flex items-center gap-3">
            <button className="p-2 -ml-2 hover:bg-gray-100 rounded-full transition-colors">
              <ArrowLeft className="w-6 h-6 text-gray-700" />
            </button>
            <div>
              <h1 className="text-xl font-bold text-gray-900 leading-tight">eSanjeevni</h1>
              <p className="text-xs text-gray-500 font-medium">Online Specialist Consultation</p>
            </div>
          </div>
        </div>

        {/* Summary Strip */}
        <div className="relative mt-4">
          <Search className="absolute left-3 top-3 w-5 h-5 text-gray-400" />
          <input 
            type="text" 
            placeholder="Search by 14-digit ABHA ID..." 
            value={searchQuery}
            onChange={(e) => setSearchQuery(e.target.value)}
            className="w-full bg-gray-50 border border-gray-200 text-gray-800 text-sm rounded-xl pl-10 pr-4 py-3 focus:outline-none focus:ring-2 focus:ring-[#3087DF]/50"
          />
        </div>
      </header>

      {/* FILTERS */}
      <div className="px-4 py-3 flex gap-2 overflow-x-auto no-scrollbar shrink-0">
        {['All', 'High Risk', 'Moderate Risk', 'Low Risk', 'Pregnancy', 'Child', ...availableDiseases].map(f => (
          <button 
            key={f}
            onClick={() => setActiveFilter(f)}
            className={`whitespace-nowrap px-4 py-1.5 rounded-full text-sm font-medium transition-colors ${
              activeFilter === f 
                ? 'bg-[#3087DF] text-white shadow-md' 
                : 'bg-white text-gray-600 border border-gray-200'
            }`}
          >
            {f}
          </button>
        ))}
      </div>

      {/* MAIN SECTION: PATIENT LIST */}
      <main className="flex-1 overflow-y-auto px-4 pb-24">
        {filteredAndSortedMembers.length === 0 ? (
          <div className="flex flex-col items-center justify-center h-64 text-center mt-10">
            <div className="w-20 h-20 bg-blue-50 rounded-full flex items-center justify-center mb-4">
              <CheckCircle className="w-10 h-10 text-gray-300" />
            </div>
            <h3 className="text-lg font-bold text-gray-800">No scheduled consultations</h3>
            <p className="text-sm text-gray-500 mt-2 mb-6">You're all caught up for now.</p>
            <button 
              onClick={() => setAddModalOpen(true)}
              className="bg-[#3087DF] text-white px-6 py-2.5 rounded-xl font-medium shadow-sm flex items-center gap-2"
            >
              <Plus className="w-5 h-5" /> Add Consultation
            </button>
          </div>
        ) : (
          filteredAndSortedMembers.map(member => (
            <PatientCard 
              key={member.id} 
              data={member} 
              onAssignClick={() => {
                setSelectedConsultationId(member.id);
                setAssignModalOpen(true);
              }}
              onStatusUpdate={updateStatus}
              onStartCall={handleStartCall}
            />
          ))
        )}
      </main>

      {/* FLOATING ACTION BUTTON */}
      <button 
        onClick={() => setAddModalOpen(true)}
        className="absolute bottom-6 right-6 bg-[#3087DF] text-white w-14 h-14 rounded-full shadow-lg flex items-center justify-center hover:bg-blue-600 transition-transform active:scale-95 z-20"
      >
        <Plus className="w-6 h-6" />
      </button>

      {/* MODALS */}
      {assignModalOpen && selectedConsultationId && (
        <AssignDoctorModal 
          consultation={members.find(c => c.id === selectedConsultationId)}
          onClose={() => setAssignModalOpen(false)}
          onAssign={handleAssignDoctor}
        />
      )}

      {addModalOpen && (
        <AddConsultationModal 
          onClose={() => setAddModalOpen(false)}
          onAdd={handleAddConsultation}
        />
      )}

    </div>
  );
}

// --- SUB-COMPONENTS ---

function PatientCard({ data, onAssignClick, onStatusUpdate, onStartCall }) {
  const doctor = data.assignedDoctorId ? DOCTORS.find(d => d.id === data.assignedDoctorId) : null;

  const statusColors = {
    'Not Started': 'bg-gray-100 text-gray-600 border-gray-200',
    'Scheduled': 'bg-blue-50 text-blue-600 border-blue-200',
    'In Progress': 'bg-orange-50 text-orange-600 border-orange-200',
    'Completed': 'bg-green-50 text-green-600 border-green-200',
  };

  const priorityColors = {
    'High Risk': 'text-red-600 bg-red-50 border-red-100',
    'Moderate Risk': 'text-amber-600 bg-amber-50 border-amber-100',
    'Low Risk': 'text-green-600 bg-green-50 border-green-100',
  };

  return (
    <div className="bg-white rounded-[16px] shadow-sm border border-gray-100 p-4 mb-4 relative overflow-hidden">
      {data.priority === 'High Risk' && (
        <div className="absolute top-0 left-0 w-1 h-full bg-red-400"></div>
      )}

      <div className="flex justify-between items-start mb-3 pl-1">
        <div className="flex items-center gap-3">
          <div className="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center text-gray-500 font-bold text-lg border-2 border-white shadow-sm">
            {data.patientName.charAt(0)}
          </div>
          <div>
            <h3 className="font-bold text-gray-900 text-base">{data.patientName}</h3>
            <p className="text-xs text-gray-500 font-medium">{data.age} yrs • {data.village}</p>
          </div>
        </div>
        <div className={`text-[10px] px-2 py-1 rounded-full font-bold uppercase tracking-wide border ${statusColors[data.status]}`}>
          {data.status}
        </div>
      </div>

      <div className="flex flex-wrap gap-1.5 mb-4 pl-1">
        <span className={`text-[10px] px-2 py-1 rounded-md font-semibold border ${priorityColors[data.priority]}`}>
          {data.priority} Priority
        </span>
        {data.diseaseTags.map(tag => (
          <span key={tag} className="text-[10px] px-2 py-1 bg-gray-100 text-gray-600 rounded-md font-medium">
            {tag}
          </span>
        ))}
        {data.referralRecommended && (
          <span className="text-[10px] px-2 py-1 bg-rose-50 text-rose-600 rounded-md font-semibold flex items-center gap-1 border border-rose-100">
            <AlertCircle className="w-3 h-3" /> Referral Recommended
          </span>
        )}
      </div>

      <div className="h-px w-full bg-gray-100 mb-4"></div>

      <div className="flex items-center justify-between pl-1">
        <div className="flex-1">
          <p className="text-[10px] text-gray-400 font-semibold uppercase tracking-wider mb-0.5">Assigned Doctor</p>
          {doctor ? (
            <div>
              <p className="font-bold text-gray-900 text-sm">{doctor.name}</p>
              <p className="text-xs text-gray-500">{doctor.spec}</p>
            </div>
          ) : (
            <p className="text-sm font-medium text-gray-400 italic">Doctor Not Assigned</p>
          )}
        </div>

        <div className="flex flex-col items-end gap-2">
          {!doctor ? (
            <button 
              onClick={onAssignClick}
              className="bg-[#3087DF]/10 text-[#3087DF] px-4 py-1.5 rounded-xl text-sm font-bold hover:bg-[#3087DF]/20 transition-colors"
            >
              Assign
            </button>
          ) : (
            <>
              {data.status === 'Completed' ? (
                <span className="text-green-500 text-sm font-bold flex items-center gap-1">
                  <CheckCircle className="w-4 h-4" /> Done
                </span>
              ) : data.status === 'In Progress' ? (
                <button 
                  onClick={() => onStartCall(data)}
                  className="bg-orange-500 text-white px-4 py-1.5 rounded-xl text-sm font-bold shadow-sm flex items-center gap-1"
                >
                  <Video className="w-4 h-4" /> Join Call
                </button>
              ) : doctor.status === 'Online' ? (
                <button 
                  onClick={() => onStartCall(data)}
                  className="bg-[#3087DF] text-white px-4 py-1.5 rounded-xl text-sm font-bold shadow-sm flex items-center gap-1"
                >
                  <PhoneCall className="w-4 h-4" /> Start
                </button>
              ) : (
                <button 
                  onClick={() => onStatusUpdate(data.id, 'Scheduled')}
                  className="bg-gray-100 text-gray-700 px-4 py-1.5 border border-gray-200 rounded-xl text-sm font-bold shadow-sm flex items-center gap-1"
                >
                  <Calendar className="w-4 h-4" /> Schedule
                </button>
              )}
            </>
          )}
        </div>
      </div>
    </div>
  );
}

function AssignDoctorModal({ consultation, onClose, onAssign }) {
  const neededSpecs = consultation.diseaseTags.map(tag => DISEASE_TO_SPEC_MAP[tag]).filter(Boolean);
  
  const sortedDoctors = [...DOCTORS].sort((a, b) => {
    const aSuggested = neededSpecs.includes(a.spec);
    const bSuggested = neededSpecs.includes(b.spec);
    
    if (aSuggested && !bSuggested) return -1;
    if (!aSuggested && bSuggested) return 1;
    if (a.status === 'Online' && b.status === 'Offline') return -1;
    if (a.status === 'Offline' && b.status === 'Online') return 1;
    return b.rating - a.rating; 
  });

  return (
    <div className="fixed inset-0 bg-black/40 z-50 flex justify-center items-end sm:items-center p-0 sm:p-4 backdrop-blur-sm">
      <div className="bg-white w-full max-w-md sm:rounded-[24px] rounded-t-[24px] overflow-hidden shadow-2xl animate-slide-up flex flex-col max-h-[85vh]">
        
        <div className="p-4 border-b border-gray-100 flex justify-between items-center bg-white sticky top-0 z-10">
          <div>
            <h2 className="text-lg font-bold text-gray-900">Assign Doctor</h2>
            <p className="text-xs text-gray-500">For {consultation.patientName} • {consultation.diseaseTags.join(', ')}</p>
          </div>
          <button onClick={onClose} className="p-2 bg-gray-50 rounded-full text-gray-500 hover:bg-gray-100">
            <X className="w-5 h-5" />
          </button>
        </div>

        <div className="p-4 overflow-y-auto flex-1 bg-gray-50 space-y-3">
          {sortedDoctors.map(doctor => {
            const isSuggested = neededSpecs.includes(doctor.spec);
            
            return (
              <div key={doctor.id} className="bg-white p-3 rounded-[16px] border border-gray-100 shadow-sm relative overflow-hidden">
                {isSuggested && (
                   <div className="absolute top-0 right-0 bg-[#3087DF]/10 text-[#3087DF] text-[10px] font-bold px-2 py-1 rounded-bl-lg">
                     Suggested Match
                   </div>
                )}
                <div className="flex justify-between items-center">
                  <div className="flex gap-3 items-center">
                     <div className="relative">
                        <div className="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center text-gray-400">
                          <UserPlus className="w-5 h-5" />
                        </div>
                        <div className={`absolute bottom-0 right-0 w-3 h-3 rounded-full border-2 border-white ${doctor.status === 'Online' ? 'bg-green-500' : 'bg-gray-400'}`}></div>
                     </div>
                     <div>
                       <h4 className="font-bold text-gray-900">{doctor.name}</h4>
                       <p className="text-xs text-[#3087DF] font-medium">{doctor.spec}</p>
                       <p className="text-[10px] text-gray-500">{doctor.hospital}</p>
                     </div>
                  </div>
                  <div className="flex flex-col items-end justify-between h-12">
                    <div className="flex items-center gap-1 text-[10px] font-bold text-amber-500">
                      <Star className="w-3 h-3 fill-amber-500" /> {doctor.rating}
                    </div>
                    <button 
                      onClick={() => onAssign(consultation.id, doctor.id)}
                      className="bg-[#3087DF] text-white text-xs font-bold px-4 py-1.5 rounded-lg shadow-sm"
                    >
                      Assign
                    </button>
                  </div>
                </div>
              </div>
            );
          })}
        </div>
      </div>
    </div>
  );
}

function AddConsultationModal({ onClose, onAdd }) {
  const [patient, setPatient] = useState('');
  const [tags, setTags] = useState([]);
  const [priority, setPriority] = useState('Routine');
  const [note, setNote] = useState('');

  const toggleTag = (tag) => {
    setTags(prev => prev.includes(tag) ? prev.filter(t => t !== tag) : [...prev, tag]);
  };

  const handleSave = () => {
    if (!patient || tags.length === 0) return;
    onAdd({
      patientName: patient,
      age: Math.floor(Math.random() * 40) + 20, 
      village: 'Rampur', 
      diseaseTags: tags,
      priority,
      status: 'Not Started',
      assignedDoctorId: null,
      waitingTime: '-',
      referralRecommended: priority === 'High',
    });
  };

  return (
    <div className="fixed inset-0 bg-black/40 z-50 flex justify-center items-end sm:items-center p-0 sm:p-4 backdrop-blur-sm">
      <div className="bg-white w-full max-w-md sm:rounded-[24px] rounded-t-[24px] overflow-hidden shadow-2xl flex flex-col animate-slide-up">
        
        <div className="p-4 border-b border-gray-100 flex justify-between items-center">
          <h2 className="text-lg font-bold text-gray-900">Add Teleconsultation</h2>
          <button onClick={onClose} className="p-2 bg-gray-50 rounded-full text-gray-500">
            <X className="w-5 h-5" />
          </button>
        </div>

        <div className="p-5 flex-1 overflow-y-auto space-y-5">
          <div>
            <label className="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-2">Select Patient</label>
            <div className="relative">
              <select 
                value={patient} 
                onChange={e => setPatient(e.target.value)}
                className="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 text-sm font-medium text-gray-900 appearance-none focus:outline-none focus:ring-2 focus:ring-[#3087DF]/50"
              >
                <option value="" disabled>Select from village list...</option>
                {AVAILABLE_PATIENTS.map(p => <option key={p} value={p}>{p}</option>)}
              </select>
              <ChevronDown className="absolute right-3 top-3.5 w-5 h-5 text-gray-400 pointer-events-none" />
            </div>
          </div>

          <div>
            <label className="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-2">Symptoms / Disease</label>
            <div className="flex flex-wrap gap-2">
              {AVAILABLE_DISEASES.map(tag => (
                <button
                  key={tag}
                  onClick={() => toggleTag(tag)}
                  className={`text-xs px-3 py-1.5 rounded-lg font-medium border transition-colors ${
                    tags.includes(tag) 
                      ? 'bg-[#3087DF]/10 border-[#3087DF] text-[#3087DF]' 
                      : 'bg-white border-gray-200 text-gray-600'
                  }`}
                >
                  {tag}
                </button>
              ))}
            </div>
          </div>

          <div>
            <label className="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-2">Priority Level</label>
            <div className="grid grid-cols-3 gap-2">
              {['Routine', 'Moderate', 'High Risk'].map(level => (
                <button
                  key={level}
                  onClick={() => setPriority(level)}
                  className={`py-2 rounded-xl text-sm font-bold border transition-colors ${
                    priority === level
                      ? level === 'High Risk' ? 'bg-red-50 border-red-200 text-red-600'
                        : level === 'Moderate' ? 'bg-amber-50 border-amber-200 text-amber-600'
                        : 'bg-green-50 border-green-200 text-green-600'
                      : 'bg-gray-50 border-gray-200 text-gray-500'
                  }`}
                >
                  {level}
                </button>
              ))}
            </div>
          </div>

          <div>
            <label className="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-2">Short Complaint Note</label>
            <textarea 
              value={note}
              onChange={e => setNote(e.target.value)}
              placeholder="E.g., Patient complaining of severe headache since 2 days."
              className="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 text-sm focus:outline-none focus:ring-2 focus:ring-[#3087DF]/50 min-h-[80px]"
            />
          </div>
        </div>

        <div className="p-4 border-t border-gray-100 bg-white">
          <button 
            onClick={handleSave}
            disabled={!patient || tags.length === 0}
            className="w-full bg-[#3087DF] disabled:bg-gray-300 text-white font-bold py-3.5 rounded-xl shadow-md transition-all active:scale-[0.98]"
          >
            Save & Add to List
          </button>
        </div>

      </div>
    </div>
  );
}

function VideoCallView({ consultation, onEndCall }) {
  const doctor = DOCTORS.find(d => d.id === consultation.assignedDoctorId);
  const remoteVideoRef = useRef(null);
  const localVideoRef = useRef(null);
  const streamRef = useRef(null);
  const [cameraOn, setCameraOn] = useState(true);
  const [micOn, setMicOn] = useState(true);

  useEffect(() => {
    // 1. Attach Local Stream
    if (consultation.stream && localVideoRef.current) {
      streamRef.current = consultation.stream;
      localVideoRef.current.srcObject = consultation.stream;
      
      // Explicitly play to prevent black screens from autoplay blocks
      localVideoRef.current.play().catch(err => console.error("Local play error:", err));
    }

    // 2. Attach Remote Stream
    if (consultation.pc) {
      consultation.pc.ontrack = (event) => {
        if (remoteVideoRef.current) {
          remoteVideoRef.current.srcObject = event.streams[0];
          
          remoteVideoRef.current.play().catch(err => console.error("Remote play error:", err));
        }
      };
    }

    // Notice: We completely removed the return () => cleanup block here. 
    // React Strict Mode was previously using it to instantly kill your camera.

  }, [consultation.stream, consultation.pc]);

  const stopCamera = () => {
    if (streamRef.current) {
      streamRef.current.getTracks().forEach(track => track.stop());
    }
  };

  const toggleCamera = () => {
    const videoTrack = streamRef.current?.getVideoTracks()[0];
    if (videoTrack) {
      videoTrack.enabled = !videoTrack.enabled;
      setCameraOn(videoTrack.enabled);
    }
  };

  const toggleMic = () => {
    const audioTrack = streamRef.current?.getAudioTracks()[0];
    if (audioTrack) {
      audioTrack.enabled = !audioTrack.enabled;
      setMicOn(audioTrack.enabled);
    }
  };

  return (
    <div className="mx-auto max-w-md bg-gray-900 min-h-screen flex flex-col relative overflow-hidden">

      <div className="flex-1 relative bg-black">
        <video
          ref={remoteVideoRef}
          autoPlay
          playsInline
          className="w-full h-full object-cover"
        />
      </div>

      {/* Self Video Preview */}
      <div className="absolute bottom-24 right-4 w-32 h-44 bg-black rounded-xl overflow-hidden border-2 border-gray-500 shadow-lg">
        <video
          ref={localVideoRef}
          autoPlay
          playsInline
          muted
          className="w-full h-full object-cover transform scale-x-[-1]" /* Added scale-x-[-1] for mirror effect */
        />
      </div>

      {/* Controls */}
      <div className="p-8 bg-gray-900 flex justify-center gap-6 items-center border-t border-gray-800">

        {/* Mic Toggle */}
        <button
          onClick={toggleMic}
          className={`w-12 h-12 rounded-full flex items-center justify-center ${
            micOn ? "bg-gray-800 hover:bg-gray-700" : "bg-red-500 hover:bg-red-600"
          } transition-colors`}
        >
          <Mic className="w-5 h-5 text-white" />
        </button>

        {/* Camera Toggle */}
        <button
          onClick={toggleCamera}
          className={`w-12 h-12 rounded-full flex items-center justify-center ${
            cameraOn ? "bg-gray-800 hover:bg-gray-700" : "bg-red-500 hover:bg-red-600"
          } transition-colors`}
        >
          <Video className="w-5 h-5 text-white" />
        </button>

        {/* End Call */}
        <button
          onClick={() => {
            stopCamera();
            onEndCall(consultation.id);
          }}
          className="w-16 h-16 bg-red-500 hover:bg-red-600 rounded-full flex items-center justify-center transition-colors shadow-lg shadow-red-500/30"
        >
          <PhoneOff className="w-7 h-7 text-white" />
        </button>

      </div>
    </div>
  );
}